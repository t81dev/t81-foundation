name: T81 Foundation CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  build-and-test:
    name: " build / ${{ matrix.os }} / ${{ matrix.compiler }}"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: ubuntu-latest
            compiler: clang
            c_compiler: clang-18
            cpp_compiler: clang++-18
          - os: macos-latest
            compiler: clang
            c_compiler: clang
            cpp_compiler: clang++
          - os: macos-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: windows-latest
            compiler: msvc
            c_compiler: cl
            cxx: cl
          - os: windows-latest
            compiler: clang-cl
            c: clang-cl
            cxx: clang-cl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create log dir
        run: mkdir -p .github/logs

      # === Linux & macOS: use ccache ===
      - name: Setup ccache (Linux/macOS only)
        if: runner.os != 'Windows'
        run: |
          ccache -z
          ccache --set-config=max_size=500M

      # === Windows: NO ccache, NO cache, NO mercy ===
      - name: Disable ccache on Windows
        if: runner.os == 'Windows'
        run: echo "CCACHE_DISABLED=1" >> $GITHUB_ENV

      - name: Setup MSVC (Windows only)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
            $( ([[ "$RUNNER_OS" == "Windows" ]] && echo "" ) || echo "-DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache" ) \
            2>&1 | tee .github/logs/build-and-test.log
        shell: bash

      - name: Nuke Windows build directory â€” absolute fresh start
        if: runner.os == 'Windows'
        run: |
          rm -rf build
          mkdir build
          echo "Windows build directory obliterated. Zero cache. Pure truth."
        shell: bash

      - name: Build
        run: |
          cmake --build build --parallel 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Test
        run: |
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Show ccache stats (non-Windows only)
        if: runner.os != 'Windows'
        run: ccache -s

      - name: Failure Summary
        if: failure()
        run: |
          echo "### Build / Test Failed" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: ${{ matrix.compiler }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Last 40 log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if command -v powershell >/dev/null 2>&1; then
            powershell -Command "if (Test-Path '.github/logs/build-and-test.log') { Get-Content '.github/logs/build-and-test.log' -Tail 40 } else { 'no log' }"
          else
            tail -n 40 .github/logs/build-and-test.log 2>/dev/null || echo "no log"
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash
