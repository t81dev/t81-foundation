name: T81 Foundation CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write # for job summaries

jobs:
  ############################################################################
  # JOB: spec-and-docs
  ############################################################################
  spec-and-docs:
    name: " lint / spec & docs "
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Start log capture
        run: mkdir -p .github/logs && echo "--- Starting log capture ---" > .github/logs/spec-and-docs.log

      - name: Install Python tools
        run: pip install mdformat mdformat-gfm mdformat-frontmatter mdformat-toc 2>&1 | tee -a .github/logs/spec-and-docs.log

      - name: Check Markdown links (lychee)
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >-
            --verbose --no-progress
            --exclude "http://localhost*"
            --exclude "https://github.com/t81dev/t81-foundation/edit*"
            .github/**/*.md spec/**/*.md docs/**/*.md README.md AGENTS.md CONTRIBUTING.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: lychee

      - name: Verify repository structure
        run: |
          set -euo pipefail
          required_dirs=("spec" "docs" "include/t81" "src" "tests")
          for d in "${required_dirs[@]}"; do
            [ -d "$d" ] || { echo "::error::Missing required directory: $d"; exit 1; }
          done
          echo "All required directories present." 2>&1 | tee -a .github/logs/spec-and-docs.log
      - name: Aggregate Lychee logs
        if: always()
        run: |
          echo "--- Lychee Output ---" >> .github/logs/spec-and-docs.log
          echo "${{ steps.lychee.outputs.stdout }}" >> .github/logs/spec-and-docs.log
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Spec & Docs Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more documentation or specification checks failed." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/spec-and-docs.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: build-and-test
  ############################################################################
  build-and-test:
    name: " build / ${{ matrix.os }} / ${{ matrix.compiler }}"
    needs: spec-and-docs
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: ubuntu-latest
            compiler: clang
            c_compiler: clang-18
            cpp_compiler: clang++-18
          - os: macos-latest
            compiler: clang
            c_compiler: clang
            cpp_compiler: clang++
          - os: macos-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: windows-latest
            compiler: msvc
            c_compiler: cl
            cpp_compiler: cl
          - os: windows-latest
            compiler: clang-cl
            c_compiler: clang-cl
            cpp_compiler: clang-cl

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -eo pipefail
          {
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build ccache gcc-14 g++-14 clang-18
          } 2>&1 | tee -a .github/logs/build-and-test.log
      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          set -eo pipefail
          {
          brew install ccache
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            brew install gcc@14
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          elif [ "${{ matrix.compiler }}" = "clang" ]; then
            # This is apple-clang, no install needed
            :
          fi
          } 2>&1 | tee -a .github/logs/build-and-test.log
      - name: Install Dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          set -eo pipefail
          {
          choco install ccache
          if [ "${{ matrix.compiler }}" = "clang-cl" ]; then
            winget install -e --id LLVM.LLVM --source winget
          fi
          } 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Configure ccache
        run: |
          ccache -z
          ccache --set-config=max_size=500M
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ runner.os == 'Linux' && '~/.ccache' || runner.os == 'macOS' && '~/Library/Caches/ccache' || 'C:/Users/runneradmin/AppData/Local/ccache' }}
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-
      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: build
          key: >-
            cmake-build-${{ runner.os }}-${{ matrix.compiler }}-
            ${{ hashFiles('CMakeLists.txt', 'cmake/**', 'include/**', 'src/**', 'tests/**') }}
          restore-keys: |
            cmake-build-${{ runner.os }}-${{ matrix.compiler }}-
      - name: Setup MSVC/cl environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          set -eo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Build
        run: |
          set -eo pipefail
          cmake --build build --parallel 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Show ccache stats
        run: ccache -s 2>&1 | tee -a .github/logs/build-and-test.log

      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Build failed" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiler**: ${{ matrix.compiler }} (${{ matrix.c_compiler }}/${{ matrix.cpp_compiler }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/build-and-test.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: static-analysis
  ############################################################################
  static-analysis:
    name: " lint / static analysis "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies
        run: |
          set -eo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build clang-18 clang-tidy-18 cppcheck iwyu 2>&1 | tee -a .github/logs/static-analysis.log
      - name: Configure CMake for analysis
        run: |
          set -eo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON 2>&1 | tee -a .github/logs/static-analysis.log
     name: T81 Foundation CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write # for job summaries

jobs:
  ############################################################################
  # JOB: spec-and-docs
  ############################################################################
  spec-and-docs:
    name: " lint / spec & docs "
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Start log capture
        run: mkdir -p .github/logs && echo "--- Starting log capture ---" > .github/logs/spec-and-docs.log

      - name: Install Python tools
        run: pip install mdformat mdformat-gfm mdformat-frontmatter mdformat-toc 2>&1 | tee -a .github/logs/spec-and-docs.log

      - name: Check Markdown links (lychee)
        uses: lycheeverse/lychee-action@v2
        with:
          fail: true
          args: >-
            --verbose --no-progress
            --exclude "http://localhost*"
            --exclude "https://github.com/t81dev/t81-foundation/edit*"
            .github/**/*.md spec/**/*.md docs/**/*.md README.md AGENTS.md CONTRIBUTING.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: lychee

      - name: Verify repository structure
        run: |
          set -euo pipefail
          required_dirs=("spec" "docs" "include/t81" "src" "tests")
          for d in "${required_dirs[@]}"; do
            [ -d "$d" ] || { echo "::error::Missing required directory: $d"; exit 1; }
          done
          echo "All required directories present." 2>&1 | tee -a .github/logs/spec-and-docs.log
      - name: Aggregate Lychee logs
        if: always()
        run: |
          echo "--- Lychee Output ---" >> .github/logs/spec-and-docs.log
          echo "${{ steps.lychee.outputs.stdout }}" >> .github/logs/spec-and-docs.log
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Spec & Docs Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more documentation or specification checks failed." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/spec-and-docs.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: build-and-test
  ############################################################################
  build-and-test:
    name: " build / ${{ matrix.os }} / ${{ matrix.compiler }}"
    needs: spec-and-docs
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: ubuntu-latest
            compiler: clang
            c_compiler: clang-18
            cpp_compiler: clang++-18
          - os: macos-latest
            compiler: clang
            c_compiler: clang
            cpp_compiler: clang++
          - os: macos-latest
            compiler: gcc
            c_compiler: gcc-14
            cpp_compiler: g++-14
          - os: windows-latest
            compiler: msvc
            c_compiler: cl
            cpp_compiler: cl
          - os: windows-latest
            compiler: clang-cl
            c_compiler: clang-cl
            cpp_compiler: clang-cl

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -eo pipefail
          {
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build ccache gcc-14 g++-14 clang-18
          } 2>&1 | tee -a .github/logs/build-and-test.log
      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          set -eo pipefail
          {
          brew install ccache
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            brew install gcc@14
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          elif [ "${{ matrix.compiler }}" = "clang" ]; then
            # This is apple-clang, no install needed
            :
          fi
          } 2>&1 | tee -a .github/logs/build-and-test.log
      - name: Install Dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          set -eo pipefail
          {
          choco install ccache
          if [ "${{ matrix.compiler }}" = "clang-cl" ]; then
            winget install -e --id LLVM.LLVM --source winget
          fi
          } 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Configure ccache
        run: |
          ccache -z
          ccache --set-config=max_size=500M
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ runner.os == 'Linux' && '~/.ccache' || runner.os == 'macOS' && '~/Library/Caches/ccache' || 'C:/Users/runneradmin/AppData/Local/ccache' }}
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-
      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: build
          key: >-
            cmake-build-${{ runner.os }}-${{ matrix.compiler }}-
            ${{ hashFiles('CMakeLists.txt', 'cmake/**', 'include/**', 'src/**', 'tests/**') }}
          restore-keys: |
            cmake-build-${{ runner.os }}-${{ matrix.compiler }}-
      - name: Setup MSVC/cl environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          set -eo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Build
        run: |
          set -eo pipefail
          cmake --build build --parallel 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/build-and-test.log
        shell: bash

      - name: Show ccache stats
        run: ccache -s 2>&1 | tee -a .github/logs/build-and-test.log

      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Build failed" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compiler**: ${{ matrix.compiler }} (${{ matrix.c_compiler }}/${{ matrix.cpp_compiler }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/build-and-test.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: static-analysis
  ############################################################################
  static-analysis:
    name: " lint / static analysis "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies
        run: |
          set -eo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build clang-18 clang-tidy-18 cppcheck iwyu 2>&1 | tee -a .github/logs/static-analysis.log
      - name: Configure CMake for analysis
        run: |
          set -eo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON 2>&1 | tee -a .github/logs/static-analysis.log
      - name: Run clang-tidy
        run: |
          set -eo pipefail
          echo "Running clang-tidy..."
          run-clang-tidy-18 -p build 2>&1 | tee -a .github/logs/static-analysis.log
        continue-on-error: true
        id: clang_tidy

      - name: Run cppcheck
        run: |
          set -eo pipefail
          echo "Running cppcheck..."
          cppcheck --enable=all --inconclusive --inline-suppr --suppress=missingIncludeSystem \
            --template=gcc --quiet --force --error-exitcode=1 \
            --inline-suppr --suppress=unmatchedSuppression \
            include/t81 tests src 2>&1 | tee cppcheck-report.txt
        continue-on-error: true
        id: cppcheck

      - name: Run include-what-you-use (IWYU)
        run: |
          set -eo pipefail
          echo "Running include-what-you-use..."
          iwyu-tool -p build -- -Xiwyu --mapping_file=.iwyu_mappings.imp \
            | tee iwyu-report.txt || true
      - name: Upload IWYU report
        uses: actions/upload-artifact@v4
        with:
          name: iwyu-report
          path: iwyu-report.txt

      - name: Check for analysis failures
        run: |
          if [ "${{ steps.clang_tidy.outcome }}" = "failure" ]; then
            echo "::error::Clang-tidy found issues."
            exit 1
          fi
          if [ "${{ steps.cppcheck.outcome }}" = "failure" ]; then
            echo "::error::Cppcheck found errors."
            exit 1
          fi
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Static Analysis Failed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.clang_tidy.outcome }}" = "failure" ]; then
            echo "- **Tool**: clang-tidy found issues." >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cppcheck.outcome }}" = "failure" ]; then
            echo "- **Tool**: cppcheck found errors." >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/static-analysis.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: coverage
  ############################################################################
  coverage:
    name: " test / coverage "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies
        run: |
          set -eo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build lcov gcc-14 g++-14 2>&1 | tee -a .github/logs/coverage.log
      - name: Configure & Build with Coverage
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-abs-path" \
            -DCMAKE_EXE_LINKER_FLAGS="-lgcov"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/coverage.log
          
            - name: Run Tests & Generate Report
        run: |
          set -eo pipefail
          {
          ctest --test-dir build --output-on-failure
          # Capture coverage
          lcov --capture --directory build --output-file coverage.info
          # Filter out system, tests, and legacy dirs, but ignore unused exclude patterns
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/legacy/*' \
                --output-file coverage.filtered.info \
                --ignore-errors unused
          # Show summary
          lcov --list coverage.filtered.info
          } 2>&1 | tee -a .github/logs/coverage.log

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.filtered.info
          token: ${{ secrets.CODECV_TOKEN }}
          fail_ci_if_error: true

      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Code Coverage Failed" >> $GITHUB_STEP_SUMMARY
          echo "The coverage report generation or upload failed." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/coverage.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: sanitizers
  ############################################################################
  sanitizers:
    name: " test / sanitizers (ASan, LSan, UBSan) "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      ASAN_OPTIONS: "detect_leaks=1:abort_on_error=1:symbolize=1:detect_stack_use_after_return=1:strict_init_order=1"
      LSAN_OPTIONS: "fast_unwind_on_malloc=0:print_suppressions=0"
      UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1:symbolize=1"
      SANITIZER_OPTIONS: "abort_on_error=1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install clang-18
        run: |
          set -eo pipefail
          sudo apt-get update -qq && sudo apt-get install -y clang-18 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Build with sanitizers
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,leak,undefined -fno-omit-frame-pointer"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Sanitizer Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "ASan, LSan, or UBSan detected an issue." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/sanitizers.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: thread-sanitizer
  ############################################################################
  thread-sanitizer:
    name: " test / thread sanitizer (TSan) "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TSAN_OPTIONS: "halt_on_error=1:second_deadlock_stack=1:symbolize=1"
      SANITIZER_OPTIONS: "abort_on_error=1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install clang-18
        run: |
          set -eo pipefail
          sudo apt-get update -qq && sudo apt-get install -y clang-18 2>&1 | tee -a .github/logs/thread-sanitizer.log
     
      - name: Build with TSan
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/thread-sanitizer.log
     
      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/thread-sanitizer.log
      
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Thread Sanitizer Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "TSan detected a data race or other threading issue." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/thread-sanitizer.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  
      - name: Run cppcheck
        run: |
          set -eo pipefail
          echo "Running cppcheck..."
          cppcheck --enable=all --inconclusive --inline-suppr --suppress=missingIncludeSystem \
            --template=gcc --quiet --force --error-exitcode=1 \
            --inline-suppr --suppress=unmatchedSuppression \
            include/t81 tests src 2>&1 | tee cppcheck-report.txt
        continue-on-error: true
        id: cppcheck

      - name: Run include-what-you-use (IWYU)
        run: |
          set -eo pipefail
          echo "Running include-what-you-use..."
          iwyu-tool -p build -- -Xiwyu --mapping_file=.iwyu_mappings.imp \
            | tee iwyu-report.txt || true
      - name: Upload IWYU report
        uses: actions/upload-artifact@v4
        with:
          name: iwyu-report
          path: iwyu-report.txt

      - name: Check for analysis failures
        run: |
          if [ "${{ steps.clang_tidy.outcome }}" = "failure" ]; then
            echo "::error::Clang-tidy found issues."
            exit 1
          fi
          if [ "${{ steps.cppcheck.outcome }}" = "failure" ]; then
            echo "::error::Cppcheck found errors."
            exit 1
          fi
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Static Analysis Failed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.clang_tidy.outcome }}" = "failure" ]; then
            echo "- **Tool**: clang-tidy found issues." >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cppcheck.outcome }}" = "failure" ]; then
            echo "- **Tool**: cppcheck found errors." >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/static-analysis.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: coverage
  ############################################################################
  coverage:
    name: " test / coverage "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install Dependencies
        run: |
          set -eo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build lcov gcc-14 g++-14 2>&1 | tee -a .github/logs/coverage.log
      - name: Configure & Build with Coverage
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=gcc-14 \
            -DCMAKE_CXX_COMPILER=g++-14 \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-abs-path" \
            -DCMAKE_EXE_LINKER_FLAGS="-lgcov"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/coverage.log
      - name: Run Tests & Generate Report
        run: |
          set -eo pipefail
          {
          ctest --test-dir build --output-on-failure

          # Ensure we use the gcov that matches g++-14 (avoids B42/B33 mismatch)
          GCOV_BIN="$(command -v gcov-14 || echo gcov-14)"

          lcov --gcov-tool "${GCOV_BIN}" \
               --capture \
               --directory build \
               --output-file coverage.info

          lcov --gcov-tool "${GCOV_BIN}" \
               --remove coverage.info '/usr/*' '*/tests/*' '*/legacy/*' \
               --output-file coverage.filtered.info

          lcov --list coverage.filtered.info
          } 2>&1 | tee -a .github/logs/coverage.log
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.filtered.info
          token: ${{ secrets.CODECV_TOKEN }}
          fail_ci_if_error: true

      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Code Coverage Failed" >> $GITHUB_STEP_SUMMARY
          echo "The coverage report generation or upload failed." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/coverage.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: sanitizers
  ############################################################################
  sanitizers:
    name: " test / sanitizers (ASan, LSan, UBSan) "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      ASAN_OPTIONS: "detect_leaks=1:abort_on_error=1:symbolize=1:detect_stack_use_after_return=1:strict_init_order=1"
      LSAN_OPTIONS: "fast_unwind_on_malloc=0:print_suppressions=0"
      UBSAN_OPTIONS: "print_stacktrace=1:halt_on_error=1:symbolize=1"
      SANITIZER_OPTIONS: "abort_on_error=1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install clang-18
        run: |
          set -eo pipefail
          sudo apt-get update -qq && sudo apt-get install -y clang-18 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Build with sanitizers
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,leak,undefined -fno-omit-frame-pointer"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/sanitizers.log
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Sanitizer Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "ASan, LSan, or UBSan detected an issue." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/sanitizers.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  ############################################################################
  # JOB: thread-sanitizer
  ############################################################################
  thread-sanitizer:
    name: " test / thread sanitizer (TSan) "
    needs: spec-and-docs
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TSAN_OPTIONS: "halt_on_error=1:second_deadlock_stack=1:symbolize=1"
      SANITIZER_OPTIONS: "abort_on_error=1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start log capture
        run: mkdir -p .github/logs

      - name: Install clang-18
        run: |
          set -eo pipefail
          sudo apt-get update -qq && sudo apt-get install -y clang-18 2>&1 | tee -a .github/logs/thread-sanitizer.log
      - name: Build with TSan
        run: |
          set -eo pipefail
          {
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer"
          cmake --build build --parallel
          } 2>&1 | tee -a .github/logs/thread-sanitizer.log
      - name: Test
        run: |
          set -eo pipefail
          ctest --test-dir build --output-on-failure --verbose 2>&1 | tee -a .github/logs/thread-sanitizer.log
      - name: Job Failure Summary
        if: failure()
        run: |
          echo "### Thread Sanitizer Job Failed" >> $GITHUB_STEP_SUMMARY
          echo "TSan detected a data race or other threading issue." >> $GITHUB_STEP_SUMMARY
          echo "- **Job**: ${{ github.job }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Most recent log lines:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 40 .github/logs/thread-sanitizer.log || echo "(log capture failed)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
