name: Build Search Index

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write          # needed to push the updated index
  pull-requests: write     # optional: allows adding a nice summary

jobs:
  build-and-update-index:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Important: fetch full history so git can create a commit
          fetch-depth: 0

      # ------------------------------------------------------------------
      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'         # caches node_modules if you ever add a package.json

      # ------------------------------------------------------------------
      - name: Install dependencies (cheerio + any others used by build_index.js)
        working-directory: docs/search
        run: |
          npm ci || npm install cheerio@1.0.0-rc.12 lunr@2.3.9

      # ------------------------------------------------------------------
      - name: Build search index
        working-directory: docs/search
        run: node build_index.js

      # ------------------------------------------------------------------
      - name: Commit & push updated search_index.json (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/search/search_index.json

          if git diff --quiet --staged; then
            echo "No changes to search_index.json â€“ nothing to commit"
            exit 0
          fi

          git commit -m "chore: regenerate search index [ci skip]"
          git push origin HEAD:main

      # ------------------------------------------------------------------
      - name: Summary
        if: success()
        run: |
          echo "### Search index updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- File: docs/search/search_index.json" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
