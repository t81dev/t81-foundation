name: Build Search Index

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/search/**'
      - 'spec/**'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write          # needed to push the updated index
  pull-requests: write     # optional: allows adding a nice summary

jobs:
  build-and-update-index:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Important: fetch full history so git can create a commit
          fetch-depth: 0

      # ------------------------------------------------------------------
      - name: Set up Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          # You can switch this back to '22' if you really want latest;
          # LTS is usually safer for npm/CLI ecosystem tooling.
          node-version: '20'
          cache: 'npm'

      # ------------------------------------------------------------------
      - name: Install dependencies (cheerio + lunr)
        working-directory: docs/search
        run: |
          # If there is a package-lock.json, use it; otherwise fall back
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install cheerio@1.0.0-rc.12 lunr@2.3.9
          fi

      # ------------------------------------------------------------------
      - name: Build search index
        working-directory: docs/search
        run: node build_index.js

      # ------------------------------------------------------------------
      # Only push back to main when we are actually on main.
      # (Prevents a manual workflow_dispatch on a feature branch from
      # accidentally pushing HEAD to main.)
      - name: Commit & push updated search_index.json (if changed)
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add docs/search/search_index.json

          if git diff --quiet --staged; then
            echo "No changes to search_index.json â€“ nothing to commit"
            exit 0
          fi

          git commit -m "chore: regenerate search index [ci skip]"
          git push origin HEAD:main

      # ------------------------------------------------------------------
      - name: Summary
        if: success()
        run: |
          echo "### Search index updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "- File: docs/search/search_index.json" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
