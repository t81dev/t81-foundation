# .github/workflows/bench.yml
name: T81 Speed Oracle

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # Needed to push badge updates

concurrency:
  group: bench
  cancel-in-progress: true

jobs:
  benchmark:
    name: ${{ matrix.os }} • ${{ matrix.arch || 'native' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: zen4
          - os: ubuntu-latest
            arch: native
          - os: macos-latest
            arch: apple-m2

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo apt-get update -qq
            sudo apt-get install -y ninja-build
          fi

      - name: Configure CMake
        run: >
          cmake -S . -B build -G Ninja
          -DCMAKE_BUILD_TYPE=Release
          -DT81_BENCHMARK=ON
          -DCMAKE_CXX_FLAGS="-O3 -march=${{ matrix.arch }} -DNDEBUG"

      - name: Build benchmark runner
        run: cmake --build build --target t81_benchmark --parallel

      - name: Run benchmarks
        run: ./build/benchmarks/t81_benchmark --reporter=json > bench.json

      - name: Generate live badge
        run: |
          # Extract key metric (example: fastest matmul in ns)
          BEST=$(jq -r '.benchmarks[] | select(.name | contains("MatMul/4096")) | .real_time' bench.json | sort -n | head -1)
          PERF=$(echo "scale=1; 1000000 / $BEST" | bc -l 2>/dev/null || echo "∞")
          
          COLOR="red"
          [[ "$PERF" > 10 ]] && COLOR="orange"
          [[ "$PERF" > 25 ]] && COLOR="yellow"
          [[ "$PERF" > 50 ]] && COLOR="green"
          [[ "$PERF" > 100 ]] && COLOR="brightgreen"

          cat > .github/badges/t81-speed.json <<EOF
          {
            "schemaVersion": 1,
            "label": "T81 Speed",
            "message": "${PERF} Gops/s",
            "color": "$COLOR",
            "style": "for-the-badge"
          }
          EOF

      - name: Update README
        run: |
          sed -i '' -e '/<!-- T81-SPEED-START -->/,/<!-- T81-SPEED-END -->/c\
          <!-- T81-SPEED-START -->\
          \
          ![T81 Speed Oracle](https://img.shields.io/endpoint?url=https%3A%2F%2Fraw.githubusercontent.com%2Ft81dev%2Ft81-foundation%2Fmain%2F.github%2Fbadges%2Ft81-speed.json&style=for-the-badge)\
          \
          <!-- T81-SPEED-END -->' README.md || true

      - name: Commit results
        run: |
          git config user.name "T81 Speed Oracle"
          git config user.email "oracle@t81.dev"
          git add .github/badges/t81-speed.json README.md
          git commit -m "oracle(bench): speed is now ${PERF} Gops/s" || echo "No changes"
          git push
