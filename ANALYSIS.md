# Analysis and Recommendations for the T81 C++20 Toolchain

This document provides a detailed analysis of the legacy T81 toolchain sources and a set of actionable recommendations for the new C++20 implementation.

## 1. Per-File Classification

Here is a breakdown of each legacy file, its role, and its recommended fate.

| File | Layer | Primary Purpose | Bucket | Justification |
| ------------------------- | -------------- | -------------------------- | ------------------------- | ---------------------------------------------------------------------------------------- |
| `t81lang_grammar.cweb` | Frontend | Grammar Spec | **Retire** | Completely superseded by the modern, more feature-rich `slang_grammer.ebnf`. |
| `t81lang_lexer.cweb` | Frontend | Lexer | **Retire** | A tightly-coupled C implementation of an obsolete language version. Rewrite in C++. |
| `t81lang_parser.cweb` | Frontend | Parser | **Retire** | A tightly-coupled C implementation of an obsolete language version. Rewrite in C++. |
| `t81lang_semantic.cweb` | Frontend | Semantic Analysis | **Retire** | A tightly-coupled C implementation of an obsolete language version. Rewrite in C++. |
| `t81lang_irgen.cweb` | Frontend | IR Generator | **Reference Only** | Generates an obsolete, custom IR. Useful only for understanding the old pipeline. |
| `t81lang_compiler.cweb` | Tooling | Compiler Driver | **Retire** | Orchestrates the obsolete CWEB frontend. |
| `tisc_ir.cweb` | IR | High-level IR Definition | **Reference Only** | Defines a high-level, symbolic IR not aligned with the formal spec. |
| `tisc_stdlib.cweb` | IR | High-level Stdlib | **Reference Only** | Defines high-level macros for the non-canonical, symbolic TISC IR. |
| `tisc_compiler.cweb` | Tooling | HVM->TISC Decompiler | **Retire** | Superseded by the more feature-rich `tisc_backend.cweb`. |
| `tisc_backend.cweb` | Tooling | HVM->TISC Decompiler | **Reference Only** | A decompiler for the non-canonical TISC IR. Keep as a reference for that tool's logic. |
| `emit_hvm.cweb` | HVM Backend | IR -> HVM Emitter | **Retire** | Tied to the obsolete CWEB frontend's custom IR. |
| `t81_to_hvm.cweb` | HVM Backend | Assembler | **Reuse as implementation** | The most feature-rich HVM assembler. Its tagged data format aligns with the VM spec. |
| `t81asm.cweb` | HVM Backend | Assembler | **Retire** | A simpler, superseded HVM assembler. |
| `hvm_assembler.cweb` | HVM Backend | Assembler | **Retire** | Another simpler, superseded HVM assembler. |
| `t81_llvm_backend.cweb` | LLVM Backend | TableGen Definitions | **Reuse as implementation** | Contains core LLVM TableGen definitions for the T81 target. |
| `T81InstrFormats.td` | LLVM Backend | TableGen Definitions | **Reuse as implementation** | An excellent, well-structured definition of T81 instruction formats for LLVM. |
| `T81InstrInfo.td` | LLVM Backend | TableGen Definitions | **Reuse as implementation** | Defines the complete T81 instruction set for LLVM. |
| `T81RegisterInfo.td` | LLVM Backend | TableGen Definitions | **Reuse as implementation** | Defines the T81 registers for LLVM. |
| `t81_codegen.cweb` | LLVM Backend | C++ Skeleton | **Reuse as implementation** | Provides the C++ implementation skeleton for the LLVM backend. |
| `t81_compile.py` | Frontend | Compiler Prototype | **Reuse as implementation** | The most modern implementation of the frontend, showing how to handle annotations. |
| `slang_grammer.ebnf` | Frontend | Grammar Spec | **Reuse as specification** | The canonical, modern grammar for T81Lang. |

## 2. Subsystem Summary and Recommendations

### T81Lang Frontend

- **Canonical Sources:** `slang_grammer.ebnf` (for grammar) and `t81_compile.py` (for semantics).
- **Conflicts/Drift:** There is a major design drift. The EBNF/Python version is far more advanced, with features like modules, attributes, and generics that are completely absent in the CWEB implementation.
- **Recommended Direction:** **Write a new C++20 frontend from scratch.** Use the EBNF file as the formal grammar to guide the implementation of a new parser. Use the Python script as a behavioral reference, especially for handling modern features like annotations. The entire CWEB-based frontend (`t81lang_*.cweb`) should be retired and treated as a historical artifact.

### TISC IR

- **Canonical Sources:** The textual, low-level assembly format generated by `t81_compile.py` and formally defined in `tisc-spec.md`.
- **Conflicts/Drift:** The legacy code contains two conflicting definitions of "TISC IR". The CWEB files define a high-level, symbolic IR for analysis, while the formal spec and Python script define a low-level, register-based assembly language that is the true compilation target.
- **Recommended Direction:** **Adopt the low-level TISC assembly as the canonical intermediate representation** for the new C++ compiler. The CWEB TISC files (`tisc_ir.cweb`, `tisc_stdlib.cweb`, `tisc_backend.cweb`) should be archived as a reference for a possible, separate high-level analysis or decompilation tool, but they should not inform the primary compiler pipeline.

### HVM Backend

- **Canonical Sources:** `t81_to_hvm.cweb` (for the assembler and binary format). The name "HVM" should be considered a legacy name for what the formal specs call the **T81VM**.
- **Conflicts/Drift:** The legacy files contain multiple, conflicting assemblers with different opcode sets and binary formats.
- **Recommended Direction:** **Unify the T81VM toolchain around the design in `t81_to_hvm.cweb`**. This file's support for tagged, complex data types (tensors, matrices) is consistent with the `t81vm-spec.md`. The other assemblers (`t81asm.cweb`, `hvm_assembler.cweb`) and the old emitter (`emit_hvm.cweb`) are superseded and should be retired.

### LLVM Backend

- **Canonical Sources:** All `.td` files (`t81_llvm_backend.cweb`, `T81InstrFormats.td`, `T81InstrInfo.td`, `T81RegisterInfo.td`) and the C++ skeleton in `t81_codegen.cweb`.
- **Conflicts/Drift:** Minimal. The LLVM backend files are internally consistent, well-structured, and follow modern LLVM development practices.
- **Recommended Direction:** **Directly reuse these files.** They are structurally sound and provide a solid foundation for the new C++20 LLVM backend. This is the most "reuse-ready" part of the legacy codebase.

## 3. Recommended Plan for C++20 Implementation

### Concrete Next Steps

1. **Frontend:** Begin by implementing a new C++20 recursive-descent or LALR parser based on the grammar in **`slang_grammer.ebnf`**. Refer to **`t81_compile.py`** for the semantics of annotations.
2. **TISC IR:** Define a C++ class structure that represents the low-level assembly instructions defined in **`tisc-spec.md`**. This will be the output of your frontend and the input to your backends.
3. **T81VM Backend:** Port the core logic from **`t81_to_hvm.cweb`** to C++ to create a canonical T81VM assembler/emitter library. This will be your primary backend for generating executable bytecode.
4. **LLVM Backend:** Integrate the existing **`.td` files** and the C++ skeleton from **`t81_codegen.cweb`** into your new C++20 toolchain's build system. This will be your secondary, high-performance backend.

### Optimal C++20 Module Layout

A high-level module layout for your new C++20 toolchain could be:

- `T81.Frontend` (Informed by `slang_grammer.ebnf` and `t81_compile.py`)
  - `Lexer`, `Parser`, `AST`, `SemanticAnalyzer`
- `T81.TISC` (Informed by `tisc-spec.md`)
  - `Instruction`, `Operand`, `Program`
- `T81.VM` (Informed by `t81_to_hvm.cweb` and `t81vm-spec.md`)
  - `Assembler`, `BytecodeEmitter`
- `T81.LLVM` (Informed by all `.td` files and `t81_codegen.cweb`)
  - `T81TargetMachine`, `T81ISelLowering`, etc.

### Surprising and Non-Obvious Insights

- **The Python script is the true "modern" reference.** The most up-to-date language semantics are not in the CWEB source but in `t81_compile.py`. The C++ frontend should align with the Python script's semantics, not the CWEB grammar.
- **"TISC IR" has two conflicting definitions.** The formal spec clarifies that the low-level, register-based assembly language is the canonical IR, not the high-level symbolic representation in the CWEB files.
- **The "HVM" files describe the T81VM.** The assembler and bytecode format defined in the HVM-related files are the implementation of the virtual machine described in `t81vm-spec.md`.
